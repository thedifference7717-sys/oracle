<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Agent">
<meta name="theme-color" content="#050510">
<title>Trading Agent</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#050510;--bg2:#08081A;--bg3:#0D0D20;
  --border:#1A1A35;--text:#F0F0FF;--muted:#4B5563;--dim:#1F2937;
  --green:#14F195;--red:#FF4D6D;--yellow:#FBBF24;--blue:#60A5FA;--orange:#F7931A;--purple:#A78BFA;
  --safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Share Tech Mono',monospace;overflow:hidden}
#app{display:flex;flex-direction:column;height:100dvh;overflow:hidden}

/* Header */
#header{flex-shrink:0;background:linear-gradient(180deg,#0A0A1E,var(--bg));border-bottom:1px solid var(--border);padding:calc(var(--safe-top) + 12px) 16px 12px}
.header-top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
.logo-wrap{display:flex;align-items:center;gap:10px}
.agent-avatar{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#A78BFA,#627EEA);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;box-shadow:0 0 15px #A78BFA40}
.logo{font-family:'Orbitron',monospace;font-size:15px;font-weight:900;letter-spacing:.1em;background:linear-gradient(90deg,#A78BFA,#60A5FA,var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-sub{font-size:8px;color:var(--dim);letter-spacing:.15em;margin-top:2px}

/* Toggle */
.toggle-wrap{display:flex;align-items:center;gap:8px}
.toggle-label{font-size:9px;color:var(--muted);letter-spacing:.1em}
#agent-toggle{position:relative;width:44px;height:24px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all .3s;flex-shrink:0}
#agent-toggle.on{background:linear-gradient(90deg,#A78BFA,var(--green));border-color:transparent;box-shadow:0 0 12px #A78BFA60}
#agent-toggle::after{content:'';position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:50%;background:#fff;transition:transform .3s;box-shadow:0 1px 4px rgba(0,0,0,.4)}
#agent-toggle.on::after{transform:translateX(20px)}

/* Stats bar */
.stats-bar{display:flex;gap:8px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:2px}
.stats-bar::-webkit-scrollbar{display:none}
.stat-pill{display:flex;flex-direction:column;align-items:center;padding:6px 12px;border-radius:8px;background:var(--bg3);border:1px solid var(--border);flex-shrink:0;min-width:60px}
.stat-val{font-size:13px;font-weight:700;font-family:'Orbitron',monospace}
.stat-lbl{font-size:7px;color:var(--muted);letter-spacing:.08em;margin-top:2px}

/* Progress */
#progress-wrap{height:2px;background:var(--bg2);flex-shrink:0;display:none}
#progress-bar{height:100%;width:0%;background:linear-gradient(90deg,#A78BFA,var(--green));transition:width .5s ease;box-shadow:0 0 8px #A78BFA80}

/* API key screen */
#api-screen{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;gap:16px}
.api-card{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:24px;width:100%;max-width:340px}
.api-title{font-family:'Orbitron',monospace;font-size:14px;font-weight:700;color:var(--purple);margin-bottom:8px;letter-spacing:.1em}
.api-desc{font-size:10px;color:var(--muted);line-height:1.7;margin-bottom:16px}
#api-input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:11px;outline:none;-webkit-appearance:none}
#api-input:focus{border-color:var(--purple);box-shadow:0 0 0 2px #A78BFA20}
#api-submit{width:100%;margin-top:10px;padding:12px;background:linear-gradient(90deg,#A78BFA,#627EEA);border:none;border-radius:8px;color:#fff;font-size:11px;font-weight:700;letter-spacing:.1em;font-family:'Orbitron',monospace;cursor:pointer;-webkit-appearance:none}
#api-submit:active{transform:scale(.98)}
.api-warning{font-size:9px;color:var(--yellow);margin-top:10px;line-height:1.6;text-align:center}

/* Main content */
#main-content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:12px 12px 0;display:none}

/* Tabs */
.tabs{display:flex;gap:6px;margin-bottom:12px}
.tab{flex:1;padding:8px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;font-size:9px;letter-spacing:.1em;color:var(--muted);text-align:center;cursor:pointer;transition:all .2s}
.tab.active{background:linear-gradient(135deg,#A78BFA20,#627EEA20);border-color:#A78BFA40;color:var(--purple)}

/* Signal cards */
.signal-card{background:linear-gradient(160deg,#0D0D1E,var(--bg2));border-radius:14px;padding:14px;margin-bottom:10px;border:1px solid transparent;position:relative;overflow:hidden}
.signal-card-glow{position:absolute;top:-50px;right:-50px;width:140px;height:140px;border-radius:50%;pointer-events:none}
.sc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.sc-coin{display:flex;align-items:center;gap:8px}
.sc-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.sc-name{font-size:12px;font-weight:700}
.sc-sub{font-size:8px;color:var(--muted);margin-top:1px}
.sc-dir{padding:3px 8px;border-radius:20px;font-size:8px;font-weight:700;letter-spacing:.1em}

/* Kalshi prices */
.k-row{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}
.k-box{background:var(--bg);border-radius:7px;padding:7px;text-align:center}
.k-lbl{font-size:7px;color:var(--muted);letter-spacing:.08em;margin-bottom:2px}
.k-val{font-family:'Orbitron',monospace;font-size:18px;font-weight:700;line-height:1}
.k-imp{font-size:7px;color:var(--dim);margin-top:1px}

/* Prob bars */
.pb-wrap{margin-bottom:5px}
.pb-meta{display:flex;justify-content:space-between;margin-bottom:2px}
.pb-lbl{font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
.pb-val{font-size:8px;font-weight:700}
.pb-track{height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.pb-fill{height:100%;border-radius:2px;transition:width 1s ease}

/* Trade recommendation */
.trade-rec{margin-top:8px;padding:10px 12px;border-radius:10px;display:flex;align-items:center;justify-content:space-between}
.trade-size{font-size:14px;font-weight:700;font-family:'Orbitron',monospace}
.trade-meta{font-size:8px;color:var(--muted);margin-top:2px}
.trade-status{font-size:9px;padding:4px 8px;border-radius:6px;font-weight:700;letter-spacing:.08em}

/* Trade log */
.trade-log-item{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.tli-left{}
.tli-coin{font-size:11px;font-weight:700}
.tli-detail{font-size:8px;color:var(--muted);margin-top:2px}
.tli-right{text-align:right}
.tli-amount{font-size:12px;font-weight:700;font-family:'Orbitron',monospace}
.tli-time{font-size:8px;color:var(--dim);margin-top:2px}
.tli-status{font-size:8px;padding:2px 7px;border-radius:4px;margin-top:3px;display:inline-block}

/* Empty state */
.empty{text-align:center;padding:40px 20px;color:var(--dim);font-size:10px;line-height:2}

/* Console */
#console-area{flex-shrink:0;background:var(--bg2);border-top:1px solid var(--border)}
#console-header{display:flex;align-items:center;gap:6px;padding:7px 14px;border-bottom:1px solid var(--border);cursor:pointer}
.cdot{width:6px;height:6px;border-radius:50%;opacity:.5}
.ctitle{font-size:8px;color:var(--dim);letter-spacing:.15em;margin-left:6px}
.cchev{font-size:10px;color:var(--dim);margin-left:auto;transition:transform .2s}
#console-log{height:80px;overflow-y:auto;padding:8px 14px;font-size:9px;line-height:1.9;-webkit-overflow-scrolling:touch}
#console-log.collapsed{height:0;padding:0;overflow:hidden}
.log-ts{color:var(--dim)}
#bottom-pad{flex-shrink:0;height:calc(var(--safe-bot) + 6px);background:var(--bg2)}

/* Daily limit bar */
.limit-bar-wrap{margin-bottom:12px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
.limit-bar-header{display:flex;justify-content:space-between;margin-bottom:6px}
.limit-bar-label{font-size:9px;color:var(--muted);letter-spacing:.08em}
.limit-bar-val{font-size:9px;font-weight:700}
.limit-bar-track{height:5px;background:var(--border);border-radius:3px;overflow:hidden}
.limit-bar-fill{height:100%;border-radius:3px;transition:width .5s ease}

/* Spinner */
.spinner{border-radius:50%;border:2px solid var(--border);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeUp .35s ease both}
.live-dot{width:5px;height:5px;border-radius:50%;background:var(--green);box-shadow:0 0 5px var(--green);animation:pulse 1.5s infinite;display:inline-block}
</style>
</head>
<body>
<div id="app">

<!-- Header -->
<div id="header">
  <div class="header-top">
    <div class="logo-wrap">
      <div class="agent-avatar">ü§ñ</div>
      <div>
        <div class="logo">TRADE AGENT</div>
        <div class="logo-sub">KALSHI AUTO-TRADER ¬∑ 15-MIN</div>
      </div>
    </div>
    <div class="toggle-wrap">
      <span class="toggle-label" id="toggle-label">OFF</span>
      <div id="agent-toggle" onclick="toggleAgent()"></div>
    </div>
  </div>
  <div class="stats-bar" id="stats-bar">
    <div class="stat-pill"><div class="stat-val" id="stat-pnl" style="color:var(--green)">$0.00</div><div class="stat-lbl">TODAY P&L</div></div>
    <div class="stat-pill"><div class="stat-val" id="stat-trades" style="color:var(--blue)">0</div><div class="stat-lbl">TRADES</div></div>
    <div class="stat-pill"><div class="stat-val" id="stat-wins" style="color:var(--green)">0</div><div class="stat-lbl">WINS</div></div>
    <div class="stat-pill"><div class="stat-val" id="stat-losses" style="color:var(--red)">0</div><div class="stat-lbl">LOSSES</div></div>
    <div class="stat-pill"><div class="stat-val" id="stat-next" style="color:var(--yellow)">--:--</div><div class="stat-lbl">NEXT SCAN</div></div>
  </div>
</div>

<div id="progress-wrap"><div id="progress-bar"></div></div>

<!-- API key screen -->
<div id="api-screen">
  <div class="api-card">
    <div class="api-title">üîë CONNECT KALSHI</div>
    <div class="api-desc">Enter your Kalshi API key to enable live trading. Your key is stored only on this device and never shared.</div>
    <input id="api-input" type="password" placeholder="Paste your Kalshi API key..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <button id="api-submit" onclick="submitKey()">CONNECT & START ‚Üí</button>
    <div class="api-warning">‚ö† This will place REAL trades with REAL money on Kalshi. $50 daily loss limit is enforced automatically.</div>
  </div>
</div>

<!-- Main content -->
<div id="main-content">
  <div style="padding:0 0 4px">

    <!-- Daily limit -->
    <div class="limit-bar-wrap">
      <div class="limit-bar-header">
        <span class="limit-bar-label">DAILY LOSS LIMIT</span>
        <span class="limit-bar-val" id="limit-val" style="color:var(--green)">$0.00 / $50.00</span>
      </div>
      <div class="limit-bar-track">
        <div class="limit-bar-fill" id="limit-fill" style="width:0%;background:var(--green)"></div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" id="tab-signals" onclick="switchTab('signals')">SIGNALS</div>
      <div class="tab" id="tab-trades" onclick="switchTab('trades')">TRADE LOG</div>
    </div>

    <!-- Signals view -->
    <div id="view-signals"></div>

    <!-- Trades view -->
    <div id="view-trades" style="display:none"></div>

    <div style="text-align:center;font-size:8px;color:var(--dim);padding:8px 0 4px">‚ö† NOT FINANCIAL ADVICE ¬∑ TRADE AT YOUR OWN RISK</div>
  </div>
</div>

<!-- Console -->
<div id="console-area">
  <div id="console-header" onclick="toggleConsole()">
    <div class="cdot" style="background:#FF4D6D"></div>
    <div class="cdot" style="background:#FBBF24"></div>
    <div class="cdot" style="background:#14F195"></div>
    <span class="ctitle">AGENT CONSOLE</span>
    <span class="cchev" id="chevron">‚ñ≤</span>
  </div>
  <div id="console-log"><span style="color:var(--dim)">// Connect Kalshi API to start agent...</span></div>
</div>
<div id="bottom-pad"></div>
</div>

<script>
const COINS=[
  {id:"BTC",name:"Bitcoin",color:"#F7931A",symbol:"‚Çø",series:"KXBTCUD"},
  {id:"ETH",name:"Ethereum",color:"#627EEA",symbol:"Œû",series:"KXETHUD"},
  {id:"SOL",name:"Solana",color:"#14F195",symbol:"‚óé",series:"KXSOLUD"},
  {id:"XRP",name:"XRP",color:"#00AAE4",symbol:"‚úï",series:"KXXRPUD"},
];

const KALSHI="https://api.elections.kalshi.com/trade-api/v2";
const DAILY_LIMIT=50;

// Bet sizing
function getBetSize(conf){
  if(conf>=90)return 5;
  if(conf>=80)return 4;
  if(conf>=70)return 3;
  if(conf>=60)return 2;
  if(conf>=50)return 1;
  return 0;
}

let state={
  apiKey:"",
  agentOn:false,
  signals:{},
  kalshi:{},
  trades:[],
  dailyLoss:0,
  scanTimer:null,
  nextScan:null,
  scanning:false,
  consoleOpen:true,
  tab:"signals",
};

// ‚îÄ‚îÄ Utils ‚îÄ‚îÄ
function ts(){return new Date().toLocaleTimeString("en-US",{hour12:false})}
function log(msg,color="#6B7280"){
  const el=document.getElementById("console-log");
  const d=document.createElement("div");
  d.innerHTML=`<span class="log-ts">[${ts()}]</span> <span style="color:${color}">${msg}</span>`;
  el.appendChild(d);el.scrollTop=el.scrollHeight;
}
function toggleConsole(){
  state.consoleOpen=!state.consoleOpen;
  document.getElementById("console-log").classList.toggle("collapsed",!state.consoleOpen);
  document.getElementById("chevron").textContent=state.consoleOpen?"‚ñ≤":"‚ñº";
}
function fmt(n,d=2){return Number(n).toLocaleString("en-US",{minimumFractionDigits:d,maximumFractionDigits:d})}

// ‚îÄ‚îÄ API Key ‚îÄ‚îÄ
function submitKey(){
  const key=document.getElementById("api-input").value.trim();
  if(!key||key.length<10){alert("Please enter a valid API key");return}
  state.apiKey=key;
  document.getElementById("api-screen").style.display="none";
  document.getElementById("main-content").style.display="block";
  log("‚úì Kalshi API key connected","#14F195");
  log("Agent ready. Toggle ON to start auto-trading.","#A78BFA");
  renderAll();
}

// ‚îÄ‚îÄ Toggle ‚îÄ‚îÄ
function toggleAgent(){
  if(!state.apiKey){return}
  state.agentOn=!state.agentOn;
  const btn=document.getElementById("agent-toggle");
  const lbl=document.getElementById("toggle-label");
  if(state.agentOn){
    btn.classList.add("on");
    lbl.textContent="ON";
    lbl.style.color="#14F195";
    log("‚ñ∂ Agent ACTIVATED ‚Äî scanning every 15 minutes","#14F195");
    runCycle();
    scheduleNext();
  } else {
    btn.classList.remove("on");
    lbl.textContent="OFF";
    lbl.style.color="";
    if(state.scanTimer)clearTimeout(state.scanTimer);
    log("‚ñ† Agent DEACTIVATED","#FF4D6D");
    document.getElementById("stat-next").textContent="--:--";
  }
}

function scheduleNext(){
  if(!state.agentOn)return;
  const next=new Date(Date.now()+15*60*1000);
  state.nextScan=next;
  if(state.scanTimer)clearTimeout(state.scanTimer);
  state.scanTimer=setTimeout(()=>{if(state.agentOn)runCycle();scheduleNext();},15*60*1000);
  // countdown
  updateCountdown();
}

function updateCountdown(){
  if(!state.nextScan||!state.agentOn){return}
  const diff=Math.max(0,Math.round((state.nextScan-Date.now())/1000));
  const m=Math.floor(diff/60);
  const s=diff%60;
  document.getElementById("stat-next").textContent=`${m}:${String(s).padStart(2,"0")}`;
  if(state.agentOn)setTimeout(updateCountdown,1000);
}

// ‚îÄ‚îÄ Kalshi fetch ‚îÄ‚îÄ
async function fetchKalshi(coin){
  try{
    const r=await fetch(`${KALSHI}/markets?series_ticker=${coin.series}&status=open&limit=3`);
    if(!r.ok)throw new Error(`HTTP ${r.status}`);
    const d=await r.json();
    const markets=(d.markets||[]).sort((a,b)=>(b.close_time||"").localeCompare(a.close_time||""));
    if(!markets.length)return null;
    const m=markets[0];
    return{ticker:m.ticker,yesPrice:m.yes_price,noPrice:m.no_price,volume:m.volume,closeTime:m.close_time,eventTicker:m.event_ticker};
  }catch(e){return null}
}

// ‚îÄ‚îÄ AI signal ‚îÄ‚îÄ
async function fetchAI(coin,kalshi){
  const ctx=kalshi?`Kalshi 15-min: YES=${kalshi.yesPrice}¬¢ (${kalshi.yesPrice}% implied up), NO=${kalshi.noPrice}¬¢, vol=${kalshi.volume}.`:"No Kalshi data.";
  const prompt=`Expert crypto analyst, 15-min Kalshi prediction market trading.
Asset: ${coin.name} (${coin.id})
${ctx}
Return ONLY valid JSON:
{"direction":"BULLISH or BEARISH or NEUTRAL","bullProb":number,"bearProb":number,"confidence":number,"targetHigh":number,"targetLow":number,"rationale":"2-3 sentences"}
bullProb+bearProb=100. If YES>55 lean bullish, NO>55 lean bearish. confidence 0-100.`;

  const r=await fetch("https://api.anthropic.com/v1/messages",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:400,messages:[{role:"user",content:prompt}]})
  });
  const d=await r.json();
  const text=(d.content||[]).map(b=>b.text||"").join("");
  try{const m=text.match(/\{[\s\S]*?\}/);return JSON.parse(m?m[0]:text)}
  catch{
    const bull=kalshi?kalshi.yesPrice:50;
    return{direction:bull>54?"BULLISH":bull<46?"BEARISH":"NEUTRAL",bullProb:bull,bearProb:100-bull,confidence:51,targetHigh:0,targetLow:0,rationale:"Signal from Kalshi implied probability and momentum."};
  }
}

// ‚îÄ‚îÄ Place trade on Kalshi ‚îÄ‚îÄ
async function placeTrade(coin,signal,kalshi,betSize){
  if(!kalshi||!kalshi.ticker){
    log(`  ‚úó ${coin.id}: No active market to trade`,"#FBBF24");
    return null;
  }

  // Determine YES or NO based on direction
  const side=signal.direction==="BULLISH"?"yes":"no";
  const price=side==="yes"?kalshi.yesPrice:kalshi.noPrice;

  log(`  ‚Ü≥ Placing ${side.toUpperCase()} ${betSize} contract(s) on ${coin.id} @ ${price}¬¢`,"#A78BFA");

  try{
    const body={
      ticker: kalshi.ticker,
      client_order_id: `agent_${Date.now()}_${coin.id}`,
      type: "limit",
      action: "buy",
      side: side,
      count: betSize,
      yes_price: side==="yes"?price:undefined,
      no_price: side==="no"?price:undefined,
    };
    // Remove undefined
    Object.keys(body).forEach(k=>body[k]===undefined&&delete body[k]);

    const r=await fetch(`${KALSHI}/portfolio/orders`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${state.apiKey}`,
      },
      body:JSON.stringify(body)
    });

    const d=await r.json();
    if(!r.ok){
      log(`  ‚úó ${coin.id}: Order failed ‚Äî ${d.error_message||r.status}`,"#FF4D6D");
      return null;
    }

    const cost=(price/100)*betSize;
    log(`  ‚úì ${coin.id}: Order placed! ${betSize}x ${side.toUpperCase()} @ ${price}¬¢ = $${cost.toFixed(2)}`,"#14F195");
    return{orderId:d.order?.order_id,side,price,count:betSize,cost,ticker:kalshi.ticker};
  }catch(e){
    log(`  ‚úó ${coin.id}: ${e.message}`,"#FF4D6D");
    return null;
  }
}

// ‚îÄ‚îÄ Main scan cycle ‚îÄ‚îÄ
async function runCycle(){
  if(state.scanning)return;
  if(state.dailyLoss>=DAILY_LIMIT){
    log("‚õî Daily loss limit reached. No more trades today.","#FF4D6D");
    return;
  }
  state.scanning=true;
  setProgress(5);

  log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê","#1F1F3A");
  log(`CYCLE START ‚Äî ${new Date().toISOString()}`,"#F0F0FF");
  log("Phase 1 ‚Ä∫ Fetching Kalshi markets","#60A5FA");

  // Fetch Kalshi
  const kalshiResults={};
  await Promise.all(COINS.map(async coin=>{
    const k=await fetchKalshi(coin);
    kalshiResults[coin.id]=k;
    state.kalshi[coin.id]=k;
    if(k)log(`  ‚úì ${coin.id}: YES=${k.yesPrice}¬¢ NO=${k.noPrice}¬¢`,"#60A5FA");
    else log(`  ‚úó ${coin.id}: No open market`,"#FBBF24");
  }));

  setProgress(30);
  log("Phase 2 ‚Ä∫ AI analysis","#A78BFA");

  // AI signals
  for(let i=0;i<COINS.length;i++){
    const coin=COINS[i];
    const kalshi=kalshiResults[coin.id];
    try{
      log(`  ‚Ü≥ Analyzing ${coin.id}...`,coin.color);
      const sig=await fetchAI(coin,kalshi);
      state.signals[coin.id]=sig;
      const betSize=getBetSize(sig.confidence);
      log(`  ‚úì ${coin.id}: ${sig.direction} conf=${sig.confidence.toFixed(0)}% ‚Üí $${betSize} bet`,coin.color);

      // Place trade if agent is on, market exists, bet size > 0, under daily limit
      if(state.agentOn&&betSize>0&&kalshi&&sig.direction!=="NEUTRAL"){
        const remaining=DAILY_LIMIT-state.dailyLoss;
        const cost=(betSize*((sig.direction==="BULLISH"?kalshi.yesPrice:kalshi.noPrice)/100));
        if(cost<=remaining){
          log(`  üí∞ Trading ${coin.id}...`,"#FBBF24");
          const order=await placeTrade(coin,sig,kalshi,betSize);
          if(order){
            const trade={
              id:Date.now()+"_"+coin.id,
              coin:coin.id,
              coinColor:coin.color,
              direction:sig.direction,
              side:order.side,
              count:order.count,
              price:order.price,
              cost:order.cost,
              confidence:sig.confidence,
              time:new Date().toLocaleTimeString(),
              status:"OPEN",
              orderId:order.orderId,
              ticker:order.ticker,
            };
            state.trades.unshift(trade);
            // Deduct from daily loss tracking (cost at risk)
            state.dailyLoss+=order.cost;
            updateStats();
          }
        } else {
          log(`  ‚ö† ${coin.id}: Would exceed daily limit, skipping`,"#FBBF24");
        }
      }
    }catch(e){
      log(`  ‚úó ${coin.id}: ${e.message}`,"#FF4D6D");
    }
    setProgress(30+(i+1)/COINS.length*65);
    renderSignals();
    await new Promise(r=>setTimeout(r,400));
  }

  log(`CYCLE COMPLETE ‚Äî ${new Date().toLocaleTimeString()}`,"#14F195");
  log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê","#1F1F3A");
  setProgress(0);
  state.scanning=false;
  updateStats();
  renderAll();
}

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
function updateStats(){
  const wins=state.trades.filter(t=>t.status==="WON").length;
  const losses=state.trades.filter(t=>t.status==="LOST").length;
  const pnl=state.trades.reduce((s,t)=>{
    if(t.status==="WON")return s+(t.payout||0)-t.cost;
    if(t.status==="LOST")return s-t.cost;
    return s;
  },0);

  document.getElementById("stat-pnl").textContent=`${pnl>=0?"":"-"}$${fmt(Math.abs(pnl))}`;
  document.getElementById("stat-pnl").style.color=pnl>=0?"var(--green)":"var(--red)";
  document.getElementById("stat-trades").textContent=state.trades.length;
  document.getElementById("stat-wins").textContent=wins;
  document.getElementById("stat-losses").textContent=losses;

  // Daily limit bar
  const pct=Math.min(100,(state.dailyLoss/DAILY_LIMIT)*100);
  document.getElementById("limit-val").textContent=`$${fmt(state.dailyLoss)} / $${DAILY_LIMIT}.00`;
  document.getElementById("limit-fill").style.width=pct+"%";
  document.getElementById("limit-fill").style.background=pct>80?"var(--red)":pct>50?"var(--yellow)":"var(--green)";
  document.getElementById("limit-val").style.color=pct>80?"var(--red)":pct>50?"var(--yellow)":"var(--green)";
}

function setProgress(n){
  const w=document.getElementById("progress-wrap");
  const b=document.getElementById("progress-bar");
  if(n>0&&n<100){w.style.display="block";b.style.width=n+"%"}
  else{w.style.display="none";b.style.width="0%"}
}

// ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ
function switchTab(t){
  state.tab=t;
  document.getElementById("tab-signals").classList.toggle("active",t==="signals");
  document.getElementById("tab-trades").classList.toggle("active",t==="trades");
  document.getElementById("view-signals").style.display=t==="signals"?"block":"none";
  document.getElementById("view-trades").style.display=t==="trades"?"block":"none";
}

// ‚îÄ‚îÄ Render signals ‚îÄ‚îÄ
function renderSignals(){
  const el=document.getElementById("view-signals");
  if(!Object.keys(state.signals).length&&!state.scanning){
    el.innerHTML=`<div class="empty">ü§ñ Agent is ready<br>Toggle ON to start auto-trading<br><span style="color:var(--dim)">Scans every 15 minutes</span></div>`;
    return;
  }

  el.innerHTML=COINS.map(coin=>{
    const sig=state.signals[coin.id];
    const k=state.kalshi[coin.id];
    const betSize=sig?getBetSize(sig.confidence):0;
    const dirColor=!sig?"#4B5563":sig.direction==="BULLISH"?"#14F195":sig.direction==="BEARISH"?"#FF4D6D":"#FBBF24";
    const closeDate=k&&k.closeTime?new Date(k.closeTime):null;
    const mins=closeDate?Math.max(0,Math.round((closeDate-Date.now())/60000)):null;

    return `<div class="signal-card fade-in" style="border:1px solid ${coin.color}20;box-shadow:0 4px 24px ${coin.color}06">
      <div class="signal-card-glow" style="background:radial-gradient(circle,${coin.color}10 0%,transparent 70%)"></div>
      <div class="sc-header">
        <div class="sc-coin">
          <div class="sc-icon" style="background:linear-gradient(135deg,${coin.color}25,${coin.color}08);border:1px solid ${coin.color}30;color:${coin.color}">${coin.symbol}</div>
          <div><div class="sc-name">${coin.id}</div><div class="sc-sub">${coin.name}</div></div>
        </div>
        ${sig?`<div class="sc-dir" style="background:${dirColor}15;border:1px solid ${dirColor}30;color:${dirColor}">${sig.direction==="BULLISH"?"‚ñ≤":sig.direction==="BEARISH"?"‚ñº":"‚óÜ"} ${sig.direction}</div>`:""}
      </div>

      ${k?`<div class="k-row">
        <div class="k-box" style="border:1px solid #14F19520"><div class="k-lbl">YES ¬∑ UP</div><div class="k-val" style="color:#14F195">${k.yesPrice}¬¢</div><div class="k-imp">${k.yesPrice}% implied</div></div>
        <div class="k-box" style="border:1px solid #FF4D6D20"><div class="k-lbl">NO ¬∑ DOWN</div><div class="k-val" style="color:#FF4D6D">${k.noPrice}¬¢</div><div class="k-imp">${k.noPrice}% implied</div></div>
      </div>`:`<div style="padding:8px;background:var(--bg3);border-radius:7px;font-size:9px;color:var(--dim);margin-bottom:8px">‚ö† No open Kalshi market</div>`}

      ${sig?`
        ${[["Bull prob",sig.bullProb,"#14F195"],["Bear prob",sig.bearProb,"#FF4D6D"],["Confidence",sig.confidence,coin.color]].map(([l,v,c])=>`
          <div class="pb-wrap"><div class="pb-meta"><span class="pb-lbl">${l}</span><span class="pb-val" style="color:${c}">${parseFloat(v).toFixed(1)}%</span></div>
          <div class="pb-track"><div class="pb-fill" style="width:${Math.min(100,v)}%;background:${c};box-shadow:0 0 6px ${c}60"></div></div></div>
        `).join("")}

        <div class="trade-rec" style="background:linear-gradient(135deg,${coin.color}14,${coin.color}06);border:1px solid ${coin.color}25;margin-top:8px">
          <div>
            <div class="trade-size" style="color:${betSize>0?coin.color:"var(--dim)"}">$${betSize} BET</div>
            <div class="trade-meta">${betSize>0?`${betSize} contract${betSize>1?"s":""} ¬∑ ‚â•${betSize>=5?90:betSize>=4?80:betSize>=3?70:betSize>=2?60:50}% conf`:"No trade (conf <50%)"}</div>
          </div>
          <div class="trade-status" style="background:${state.agentOn?"#14F19520":"#374151"};color:${state.agentOn?"var(--green)":"var(--dim)"}">
            ${state.agentOn?"üü¢ AUTO":"‚è∏ OFF"}
          </div>
        </div>
        <div style="font-size:9px;color:var(--muted);margin-top:8px;line-height:1.6">${sig.rationale}</div>
      `:`<div style="text-align:center;padding:16px;color:var(--dim);font-size:10px">${state.scanning?"Analyzing...":"Awaiting scan..."}</div>`}
    </div>`;
  }).join("");
}

// ‚îÄ‚îÄ Render trades ‚îÄ‚îÄ
function renderTrades(){
  const el=document.getElementById("view-trades");
  if(!state.trades.length){
    el.innerHTML=`<div class="empty">üìã No trades yet<br>Turn agent ON to start trading</div>`;
    return;
  }
  el.innerHTML=state.trades.map(t=>{
    const statusColor=t.status==="WON"?"var(--green)":t.status==="LOST"?"var(--red)":t.status==="OPEN"?"var(--yellow)":"var(--muted)";
    return`<div class="trade-log-item fade-in">
      <div class="tli-left">
        <div class="tli-coin" style="color:${t.coinColor}">${t.coin} <span style="color:${t.direction==="BULLISH"?"var(--green)":"var(--red)"}">${t.direction==="BULLISH"?"‚ñ≤":"‚ñº"}</span></div>
        <div class="tli-detail">${t.count} contract${t.count>1?"s":""} ¬∑ ${t.side.toUpperCase()} @ ${t.price}¬¢ ¬∑ conf ${t.confidence.toFixed(0)}%</div>
        <span class="tli-status" style="background:${statusColor}20;color:${statusColor}">${t.status}</span>
      </div>
      <div class="tli-right">
        <div class="tli-amount" style="color:${t.status==="WON"?"var(--green)":t.status==="LOST"?"var(--red)":"var(--yellow)"}">
          ${t.status==="WON"?"+$"+fmt((t.payout||0)-t.cost):t.status==="LOST"?"-$"+fmt(t.cost):"$"+fmt(t.cost)}
        </div>
        <div class="tli-time">${t.time}</div>
      </div>
    </div>`;
  }).join("");
}

function renderAll(){
  renderSignals();
  renderTrades();
  updateStats();
}

// Init
renderSignals();
</script>
</body>
</html>
